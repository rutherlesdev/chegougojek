 <?php
 
 /**
Class definition of ZorowTech MPESA API by Isaac Sichangi
isaacsichangi@gmail.com

This is the full list of ISO 4217 Currency Codes supported
AED-United Arab Emirates Dirham (AED)
AFN-Afghan Afghani (AFN)
ALL-Albanian Lek (ALL)
AMD-Armenian Dram (AMD)
ANG-Netherlands Antillean Guilder (ANG)
AOA-Angolan Kwanza (AOA)
AUD-Australian Dollar (A$)
AWG-Aruban Florin (AWG)
AZN-Azerbaijani Manat (AZN)
BAM-Bosnia-Herzegovina Convertible Mark (BAM)
BBD-Barbadian Dollar (BBD)
BDT-Bangladeshi Taka (BDT)
BGN-Bulgarian Lev (BGN)
BHD-Bahraini Dinar (BHD)
BIF-Burundian Franc (BIF)
BMD-Bermudan Dollar (BMD)
BND-Brunei Dollar (BND)
BOB-Bolivian Boliviano (BOB)
BRL-Brazilian Real (R$)
BSD-Bahamian Dollar (BSD)
BTC-Bitcoin (฿)
BTN-Bhutanese Ngultrum (BTN)
BWP-Botswanan Pula (BWP)
BYN-Belarusian Ruble (BYN)
BYR-Belarusian Ruble (2000-2016) (BYR)
BZD-Belize Dollar (BZD)
CAD-Canadian Dollar (CA$)
CDF-Congolese Franc (CDF)
CHF-Swiss Franc (CHF)
CLF-Chilean Unit of Account (UF) (CLF)
CLP-Chilean Peso (CLP)
CNH-CNH (CNH)
CNY-Chinese Yuan (CN¥)
COP-Colombian Peso (COP)
CRC-Costa Rican Colón (CRC)
CUP-Cuban Peso (CUP)
CVE-Cape Verdean Escudo (CVE)
CZK-Czech Republic Koruna (CZK)
DEM-German Mark (DEM)
DJF-Djiboutian Franc (DJF)
DKK-Danish Krone (DKK)
DOP-Dominican Peso (DOP)
DZD-Algerian Dinar (DZD)
EGP-Egyptian Pound (EGP)
ERN-Eritrean Nakfa (ERN)
ETB-Ethiopian Birr (ETB)
EUR-Euro (€)
FIM-Finnish Markka (FIM)
FJD-Fijian Dollar (FJD)
FKP-Falkland Islands Pound (FKP)
FRF-French Franc (FRF)
GBP-British Pound (£)
GEL-Georgian Lari (GEL)
GHS-Ghanaian Cedi (GHS)
GIP-Gibraltar Pound (GIP)
GMD-Gambian Dalasi (GMD)
GNF-Guinean Franc (GNF)
GTQ-Guatemalan Quetzal (GTQ)
GYD-Guyanaese Dollar (GYD)
HKD-Hong Kong Dollar (HK$)
HNL-Honduran Lempira (HNL)
HRK-Croatian Kuna (HRK)
HTG-Haitian Gourde (HTG)
HUF-Hungarian Forint (HUF)
IDR-Indonesian Rupiah (IDR)
IEP-Irish Pound (IEP)
ILS-Israeli New Sheqel (₪)
INR-Indian Rupee (₹)
IQD-Iraqi Dinar (IQD)
IRR-Iranian Rial (IRR)
ISK-Icelandic Króna (ISK)
ITL-Italian Lira (ITL)
JMD-Jamaican Dollar (JMD)
JOD-Jordanian Dinar (JOD)
JPY-Japanese Yen (¥)
KES-Kenyan Shilling (KES)
KGS-Kyrgystani Som (KGS)
KHR-Cambodian Riel (KHR)
KMF-Comorian Franc (KMF)
KPW-North Korean Won (KPW)
KRW-South Korean Won (₩)
KWD-Kuwaiti Dinar (KWD)
KYD-Cayman Islands Dollar (KYD)
KZT-Kazakhstani Tenge (KZT)
LAK-Laotian Kip (LAK)
LBP-Lebanese Pound (LBP)
LKR-Sri Lankan Rupee (LKR)
LRD-Liberian Dollar (LRD)
LSL-Lesotho Loti (LSL)
LTL-Lithuanian Litas (LTL)
LVL-Latvian Lats (LVL)
LYD-Libyan Dinar (LYD)
MAD-Moroccan Dirham (MAD)
MDL-Moldovan Leu (MDL)
MGA-Malagasy Ariary (MGA)
MKD-Macedonian Denar (MKD)
MMK-Myanmar Kyat (MMK)
MNT-Mongolian Tugrik (MNT)
MOP-Macanese Pataca (MOP)
MRO-Mauritanian Ouguiya (MRO)
MUR-Mauritian Rupee (MUR)
MVR-Maldivian Rufiyaa (MVR)
MWK-Malawian Kwacha (MWK)
MXN-Mexican Peso (MX$)
MYR-Malaysian Ringgit (MYR)
MZN-Mozambican Metical (MZN)
NAD-Namibian Dollar (NAD)
NGN-Nigerian Naira (NGN)
NIO-Nicaraguan Córdoba (NIO)
NOK-Norwegian Krone (NOK)
NPR-Nepalese Rupee (NPR)
NZD-New Zealand Dollar (NZ$)
OMR-Omani Rial (OMR)
PAB-Panamanian Balboa (PAB)
PEN-Peruvian Nuevo Sol (PEN)
PGK-Papua New Guinean Kina (PGK)
PHP-Philippine Peso (PHP)
PKG-PKG (PKG)
PKR-Pakistani Rupee (PKR)
PLN-Polish Zloty (PLN)
PYG-Paraguayan Guarani (PYG)
QAR-Qatari Rial (QAR)
RON-Romanian Leu (RON)
RSD-Serbian Dinar (RSD)
RUB-Russian Ruble (RUB)
RWF-Rwandan Franc (RWF)
SAR-Saudi Riyal (SAR)
SBD-Solomon Islands Dollar (SBD)
SCR-Seychellois Rupee (SCR)
SDG-Sudanese Pound (SDG)
SEK-Swedish Krona (SEK)
SGD-Singapore Dollar (SGD)
SHP-St. Helena Pound (SHP)
SKK-Slovak Koruna (SKK)
SLL-Sierra Leonean Leone (SLL)
SOS-Somali Shilling (SOS)
SRD-Surinamese Dollar (SRD)
STD-São Tomé &amp; Príncipe Dobra (STD)
SVC-Salvadoran Colón (SVC)
SYP-Syrian Pound (SYP)
SZL-Swazi Lilangeni (SZL)
THB-Thai Baht (THB)
TJS-Tajikistani Somoni (TJS)
TMT-Turkmenistani Manat (TMT)
TND-Tunisian Dinar (TND)
TOP-Tongan Paʻanga (TOP)
TRY-Turkish Lira (TRY)
TTD-Trinidad &amp; Tobago Dollar (TTD)
TWD-New Taiwan Dollar (NT$)
TZS-Tanzanian Shilling (TZS)
UAH-Ukrainian Hryvnia (UAH)
UGX-Ugandan Shilling (UGX)
USD-US Dollar ($)
UYU-Uruguayan Peso (UYU)
UZS-Uzbekistani Som (UZS)
VEF-Venezuelan Bolívar (VEF)
VND-Vietnamese Dong (₫)
VUV-Vanuatu Vatu (VUV)
WST-Samoan Tala (WST)
XAF-Central African CFA Franc (FCFA)
XCD-East Caribbean Dollar (EC$)
XDR-Special Drawing Rights (XDR)
XOF-West African CFA Franc (CFA)
XPF-CFP Franc (CFPF)
YER-Yemeni Rial (YER)
ZAR-South African Rand (ZAR)
ZMK-Zambian Kwacha (1968–2012) (ZMK)
ZMW-Zambian Kwacha (ZMW)
ZWL-Zimbabwean Dollar (2009) (ZWL)
  
 **/
 
 define("MPESA_LIVE", 1);
 define("MPESA_DEMO", 0);
 
 class ZorowPesa {
	 
 /* Member variables */
  private $API_KEY;
  private $API_STATUS;
 
  function __construct($api_key, $api_status) {
	  
   $this->API_KEY = $api_key;
   $this->API_STATUS = $api_status;
   
}
  
 
function paymentCode(){

	mt_srand((double)microtime() * 1000000);

	$id = substr(md5(uniqid(rand())), 0,12);
	
	$code = strtoupper($id);
	
	return $code;
}
 
 
 function convertValue($from_currency, $to_currency, $amount){



	$results = $this->converCurrency($from_currency,$to_currency,$amount);

	$regularExpression     = '#\<span class=bld\>(.+?)\<\/span\>#s';

	preg_match($regularExpression, $results, $finalData);

	//$val = trim(str_replace($to_currency, "",$finalData[0]));

	$val = floatval(preg_replace("/[^-0-9\.]/","",$finalData[0]));

	return floatval($val);

}



function converCurrency($from,$to,$amount){
	
	 if(is_callable('curl_init')){

	$url = "https://www.google.com/finance/converter?a=$amount&from=$from&to=$to";

	$request = curl_init();

	$timeOut = 0;

	curl_setopt ($request, CURLOPT_URL, $url);

	curl_setopt ($request, CURLOPT_RETURNTRANSFER, 1);

	curl_setopt ($request, CURLOPT_USERAGENT,"Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 6.1)");

	curl_setopt ($request, CURLOPT_CONNECTTIMEOUT, $timeOut);

	$response = curl_exec($request);

	curl_close($request);

	return $response;
	
	 }else{
		 
	$response = "Libcurl has not been enabled on this server";
	return $response;
		 
	 }

}

function loadResources(){
echo '<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>' ."\n";
echo '<link rel="stylesheet" href="https://www.zorowtech.com/mpesaapi/css/mpesaapi.css">' ."\n";
echo '<script type="text/javascript" src="https://www.zorowtech.com/mpesaapi/js/mpesaapi.js">  </script>' ."\n";
echo '<script type="text/javascript" src="https://www.zorowtech.com/mpesaapi/js/config.js">  </script>' ."\n";	

}

function setValues($USERID, $PRODUCT_ID, $AMOUNT, $PAYMENT_CODE,  $CALLBACK_URL){
	
echo '<input type ="hidden" value="'.$USERID.'" id="uid"/>' ."\n";
echo '<input type ="hidden" value="'.$PRODUCT_ID.'" id="pid"/>'."\n";
echo '<input type ="hidden" value="'.$AMOUNT.'" id="cost"/>'."\n";
echo '<input type ="hidden" value="'. $this->API_KEY.'" id="apikey"/>'."\n";
echo '<input type ="hidden" value="'.$PAYMENT_CODE.'" id="paymentcode"/>'."\n";	
echo '<input type ="hidden" value="'.$this->API_STATUS.'" id="status"/>'."\n";
echo '<input type ="hidden" value="'.$CALLBACK_URL.'" id="callback"/>'."\n";

}

/**
* Default currency is KES
* All currencies should be input using the ISO 4217 Currency Codes 
*  reference on wikipedia https://en.wikipedia.org/wiki/ISO_4217
**/
function setupPayment($USERID, $PRODUCT_ID, $AMOUNT, $CURRENCY, $CALLBACK_URL){
	
if(empty($USERID) || empty($PRODUCT_ID) || empty($AMOUNT) || empty($CURRENCY) || empty( $CALLBACK_URL)){
	
echo '<p> input all the parameters for the setupPayment() function  </p>';
	
}else{

if($CURRENCY == "KES" || $CURRENCY == "KSH"){
	
$CONVERTED_AMOUNT = $AMOUNT;
		
}else{
	
 $CONVERTED_AMOUNT=ceil( $this->convertValue($CURRENCY, 'KES', $AMOUNT));
 	
}

if(is_numeric($CONVERTED_AMOUNT)){
	
	
if($CONVERTED_AMOUNT >= 10){
	
$PAYMENT_CODE = $this->paymentCode();

if (!filter_var($CALLBACK_URL, FILTER_VALIDATE_URL) === false) {
	
if($this->API_STATUS == MPESA_LIVE || $this->API_STATUS == MPESA_DEMO){
	
$this->setValues($USERID, $PRODUCT_ID, $CONVERTED_AMOUNT, $PAYMENT_CODE, $CALLBACK_URL);	

}else{
	
die ('<p>input a valid API_STATUS using the constantS MPESA_LIVE or MPESA_DEMO </p>');
	
}

}else{
	
die ('<p>input a valid callback url - '.$CALLBACK_URL.'</p>');
	
}
	
}else{
	
die ('<p>The minimum amount that can be set is 10Ksh you have set '.$CONVERTED_AMOUNT.' KSH</p>');
	
	
}
	
	
}else{
	
die ('<p>'.$CONVERTED_AMOUNT.' = check if your currency code complies with <a href="http://www.xe.com/iso4217.php" target="new"> ISO 4217</a> Currency Codes </p>');
	
	
}


}
	
}
  
 }
 

 ?>